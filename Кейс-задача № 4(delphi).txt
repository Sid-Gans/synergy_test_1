unit WebModuleUnit;

interface

uses
  System.SysUtils, System.Classes, Web.HTTPApp, Data.DB, Data.SqlExpr,
  Data.DBXMySQL, Data.FMTBcd, DBXCommon;

type
  TWebModule1 = class(TWebModule)
    SQLConnection1: TSQLConnection;
    procedure WebModule1DefaultHandlerAction(Sender: TObject;
      Request: TWebRequest; Response: TWebResponse; var Handled: Boolean);
    procedure WebModule1ordersAction(Sender: TObject; Request: TWebRequest;
      Response: TWebResponse; var Handled: Boolean);
  private
    function GetOrdersJSON: string;
  public
    { Public declarations }
  end;

var
  WebModuleClass: TComponentClass = TWebModule1;

implementation

uses
  System.JSON, DBXJSON;

{$R *.dfm}

procedure TWebModule1.WebModule1DefaultHandlerAction(Sender: TObject;
  Request: TWebRequest; Response: TWebResponse; var Handled: Boolean);
begin
  Response.Content := 
    '<html><head><title>Travel Orders System</title>' +
    '<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">' +
    '</head><body>' +
    '<div class="container mt-5">' +
    '<h1>Система учета заказов</h1>' +
    '<p><a href="/orders" class="btn btn-primary">Список заказов (JSON)</a></p>' +
    '</div></body></html>';
end;

function TWebModule1.GetOrdersJSON: string;
var
  Query: TSQLQuery;
  JSONArray: TJSONArray;
  JSONObject: TJSONObject;
begin
  Query := TSQLQuery.Create(nil);
  try
    Query.SQLConnection := SQLConnection1;
    Query.SQL.Text := 'SELECT o.OrderID, c.FirstName, c.LastName, s.Name as ServiceName, ' +
                      'o.OrderDate, o.Status FROM Orders o ' +
                      'JOIN Clients c ON o.ClientID = c.ClientID ' +
                      'JOIN Services s ON o.ServiceID = s.ServiceID';
    Query.Open;
    
    JSONArray := TJSONArray.Create;
    try
      while not Query.Eof do
      begin
        JSONObject := TJSONObject.Create;
        JSONObject.AddPair('OrderID', TJSONNumber.Create(Query.FieldByName('OrderID').AsInteger));
        JSONObject.AddPair('Client', Query.FieldByName('FirstName').AsString + ' ' + 
          Query.FieldByName('LastName').AsString);
        JSONObject.AddPair('Service', Query.FieldByName('ServiceName').AsString);
        JSONObject.AddPair('OrderDate', FormatDateTime('yyyy-mm-dd', Query.FieldByName('OrderDate').AsDateTime));
        JSONObject.AddPair('Status', Query.FieldByName('Status').AsString);
        
        JSONArray.AddElement(JSONObject);
        Query.Next;
      end;
      Result := JSONArray.ToString;
    finally
      JSONArray.Free;
    end;
  finally
    Query.Free;
  end;
end;

procedure TWebModule1.WebModule1ordersAction(Sender: TObject;
  Request: TWebRequest; Response: TWebResponse; var Handled: Boolean);
begin
  Response.ContentType := 'application/json';
  Response.Content := GetOrdersJSON;
end;

end.
